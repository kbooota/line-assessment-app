<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINEアンケート</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 540px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .btn-primary {
            background-color: #06C755;
            border-color: #06C755;
        }
        .btn-primary:hover {
            background-color: #05a847;
            border-color: #05a847;
        }
        .form-label {
            font-weight: bold;
        }
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        .success-message {
            display: none;
            text-align: center;
            margin: 20px 0;
            color: #06C755;
        }
        .error-message {
            display: none;
            text-align: center;
            margin: 20px 0;
            color: #dc3545;
        }
        iframe {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">アンケート</h1>
        
        <div id="loginRequired" style="display: none;">
            <p class="text-center">このアンケートに回答するには、LINEログインが必要です。</p>
            <div class="text-center">
                <button id="loginBtn" class="btn btn-primary">LINEでログイン</button>
            </div>
        </div>
        
        <form id="surveyForm" style="display: none;" target="hiddenFrame">
            <!-- 非表示フィールド - LINEユーザー情報用 -->
            <input type="hidden" id="userId" name="userId" value="">
            <input type="hidden" id="displayName" name="displayName" value="">
            <input type="hidden" id="timestamp" name="timestamp" value="">
            
            <!-- 質問1 -->
            <div class="mb-4">
                <label for="question1" class="form-label">Q1: 当サービスをどのように知りましたか？</label>
                <select class="form-select" id="question1" name="question1" required>
                    <option value="" selected disabled>選択してください</option>
                    <option value="友人・知人">友人・知人</option>
                    <option value="SNS">SNS</option>
                    <option value="検索エンジン">検索エンジン</option>
                    <option value="広告">広告</option>
                    <option value="その他">その他</option>
                </select>
            </div>
            
            <!-- 質問2 -->
            <div class="mb-4">
                <label class="form-label">Q2: 当サービスの満足度を教えてください。</label>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="question2" id="satisfaction5" value="5" required>
                    <label class="form-check-label" for="satisfaction5">5 (非常に満足)</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="question2" id="satisfaction4" value="4">
                    <label class="form-check-label" for="satisfaction4">4 (満足)</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="question2" id="satisfaction3" value="3">
                    <label class="form-check-label" for="satisfaction3">3 (普通)</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="question2" id="satisfaction2" value="2">
                    <label class="form-check-label" for="satisfaction2">2 (不満)</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="question2" id="satisfaction1" value="1">
                    <label class="form-check-label" for="satisfaction1">1 (非常に不満)</label>
                </div>
            </div>
            
            <!-- 質問3 -->
            <div class="mb-4">
                <label for="question3" class="form-label">Q3: 改善して欲しい点があれば教えてください。</label>
                <textarea class="form-control" id="question3" name="question3" rows="3"></textarea>
            </div>
            
            <div class="text-center mb-3">
                <button type="submit" class="btn btn-primary">送信する</button>
            </div>
        </form>
        
        <!-- 非表示iframeでフォーム送信結果を受け取る -->
        <iframe name="hiddenFrame" id="hiddenFrame"></iframe>
        
        <div id="loading" class="loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>送信中...</p>
        </div>
        
        <div id="successMessage" class="success-message">
            <p><strong>アンケートが送信されました！</strong></p>
            <p>ご協力ありがとうございました。</p>
            <button id="closeBtn" class="btn btn-primary">閉じる</button>
        </div>
        
        <div id="errorMessage" class="error-message">
            <p><strong>エラーが発生しました</strong></p>
            <p>もう一度お試しください。</p>
            <button id="retryBtn" class="btn btn-outline-primary">再試行</button>
        </div>
    </div>

    <!-- LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // LIFF初期化
            const liffId = "2007103197-aQzRZN9v"; // LIFF IDを設定
            const gasUrl = "https://script.google.com/a/macros/brandoff.co.jp/s/AKfycbxs4gwgCqe6JCsr5Be5At6nbNuSmGdn1rNQDZqTQgx8CZHhOkKP43mbPwFgtJSpdjMG/exec"; // Google Apps ScriptのURLを設定
            
            let userProfile = null;
            
            // フォームの送信先URLを設定
            document.getElementById('surveyForm').action = gasUrl;
            document.getElementById('surveyForm').method = 'post';
            
            // LIFF初期化
            console.log("LIFF初期化を開始します");
            liff.init({
                liffId: liffId
            }).then(() => {
                console.log("LIFF initialized successfully");
                
                // ログイン状態のチェック
                if (!liff.isLoggedIn()) {
                    console.log("ユーザーはログインしていません");
                    document.getElementById('loginRequired').style.display = 'block';
                } else {
                    console.log("ユーザーはログイン済みです");
                    // ユーザープロフィール取得
                    liff.getProfile().then(profile => {
                        userProfile = profile;
                        console.log(`プロフィール取得成功: ${profile.displayName}`);
                        
                        // ユーザー情報をフォームのhidden項目に設定
                        document.getElementById('userId').value = profile.userId;
                        document.getElementById('displayName').value = profile.displayName;
                        document.getElementById('timestamp').value = new Date().toISOString();
                        
                        document.getElementById('surveyForm').style.display = 'block';
                    }).catch(err => {
                        console.error("Error getting profile", err);
                    });
                }
            }).catch(err => {
                console.error("Error initializing LIFF", err);
            });
            
            // ログインボタン
            document.getElementById('loginBtn').addEventListener('click', () => {
                liff.login();
            });
            
            // フォーム送信
            document.getElementById('surveyForm').addEventListener('submit', (e) => {
                console.log("フォーム送信が開始されました");
                
                // タイムスタンプ更新
                document.getElementById('timestamp').value = new Date().toISOString();
                
                // 送信中表示
                document.getElementById('surveyForm').style.display = 'none';
                document.getElementById('loading').style.display = 'block';
            });
            
            // iframe読み込み完了イベント（レスポンス受信）
            document.getElementById('hiddenFrame').addEventListener('load', (e) => {
                // 初回ロード時は無視
                if (!document.getElementById('loading').style.display || document.getElementById('loading').style.display === 'none') {
                    return;
                }
                
                try {
                    const frameContent = document.getElementById('hiddenFrame').contentDocument || 
                                         document.getElementById('hiddenFrame').contentWindow.document;
                    
                    // レスポンスのテキスト取得
                    const responseText = frameContent.body.innerText || frameContent.body.textContent;
                    console.log("レスポンス:", responseText);
                    
                    // JSON解析
                    let response;
                    try {
                        response = JSON.parse(responseText);
                    } catch (e) {
                        // JSONでない場合はそのまま処理
                        response = { success: responseText.includes("success") };
                    }
                    
                    document.getElementById('loading').style.display = 'none';
                    
                    if (response && response.success) {
                        document.getElementById('successMessage').style.display = 'block';
                    } else {
                        document.getElementById('errorMessage').style.display = 'block';
                    }
                } catch (error) {
                    console.error("Response handling error:", error);
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('errorMessage').style.display = 'block';
                }
            });
            
            // 閉じるボタン
            document.getElementById('closeBtn').addEventListener('click', () => {
                liff.closeWindow();
            });
            
            // 再試行ボタン
            document.getElementById('retryBtn').addEventListener('click', () => {
                document.getElementById('errorMessage').style.display = 'none';
                document.getElementById('surveyForm').style.display = 'block';
            });
        });
    </script>
</body>
</html>
