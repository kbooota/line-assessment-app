<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINEアンケート</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 540px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .btn-primary {
            background-color: #06C755;
            border-color: #06C755;
        }
        .btn-primary:hover {
            background-color: #05a847;
            border-color: #05a847;
        }
        .form-label {
            font-weight: bold;
        }
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        .success-message {
            display: none;
            text-align: center;
            margin: 20px 0;
            color: #06C755;
        }
        .error-message {
            display: none;
            text-align: center;
            margin: 20px 0;
            color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">アンケート</h1>
        
        <div id="loginRequired" style="display: none;">
            <p class="text-center">このアンケートに回答するには、LINEログインが必要です。</p>
            <div class="text-center">
                <button id="loginBtn" class="btn btn-primary">LINEでログイン</button>
            </div>
        </div>
        
        <form id="surveyForm" style="display: none;">
            <!-- 質問1 -->
            <div class="mb-4">
                <label for="question1" class="form-label">Q1: 当サービスをどのように知りましたか？</label>
                <select class="form-select" id="question1" name="question1" required>
                    <option value="" selected disabled>選択してください</option>
                    <option value="友人・知人">友人・知人</option>
                    <option value="SNS">SNS</option>
                    <option value="検索エンジン">検索エンジン</option>
                    <option value="広告">広告</option>
                    <option value="その他">その他</option>
                </select>
            </div>
            
            <!-- 質問2 -->
            <div class="mb-4">
                <label class="form-label">Q2: 当サービスの満足度を教えてください。</label>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="question2" id="satisfaction5" value="5" required>
                    <label class="form-check-label" for="satisfaction5">5 (非常に満足)</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="question2" id="satisfaction4" value="4">
                    <label class="form-check-label" for="satisfaction4">4 (満足)</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="question2" id="satisfaction3" value="3">
                    <label class="form-check-label" for="satisfaction3">3 (普通)</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="question2" id="satisfaction2" value="2">
                    <label class="form-check-label" for="satisfaction2">2 (不満)</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="question2" id="satisfaction1" value="1">
                    <label class="form-check-label" for="satisfaction1">1 (非常に不満)</label>
                </div>
            </div>
            
            <!-- 質問3 -->
            <div class="mb-4">
                <label for="question3" class="form-label">Q3: 改善して欲しい点があれば教えてください。</label>
                <textarea class="form-control" id="question3" name="question3" rows="3"></textarea>
            </div>
            
            <div class="text-center mb-3">
                <button type="submit" class="btn btn-primary">送信する</button>
            </div>
        </form>
        
        <div id="loading" class="loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>送信中...</p>
        </div>
        
        <div id="successMessage" class="success-message">
            <p><strong>アンケートが送信されました！</strong></p>
            <p>ご協力ありがとうございました。</p>
            <button id="closeBtn" class="btn btn-primary">閉じる</button>
        </div>
        
        <div id="errorMessage" class="error-message">
            <p><strong>エラーが発生しました</strong></p>
            <p>もう一度お試しください。</p>
            <button id="retryBtn" class="btn btn-outline-primary">再試行</button>
        </div>
    </div>

    <!-- LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // LIFF初期化
            const liffId = "2007103197-aQzRZN9v"; // LIFF IDを設定
            const gasUrl = "https://script.google.com/a/macros/brandoff.co.jp/s/AKfycbxs4gwgCqe6JCsr5Be5At6nbNuSmGdn1rNQDZqTQgx8CZHhOkKP43mbPwFgtJSpdjMG/exec"; // Google Apps ScriptのURLを設定
            
            let userProfile = null;
            
            // LIFF初期化
            liff.init({
                liffId: liffId
            }).then(() => {
                console.log("LIFF initialized");
                
                // ログイン状態のチェック
                if (!liff.isLoggedIn()) {
                    document.getElementById('loginRequired').style.display = 'block';
                } else {
                    // ユーザープロフィール取得
                    liff.getProfile().then(profile => {
                        userProfile = profile;
                        document.getElementById('surveyForm').style.display = 'block';
                    }).catch(err => {
                        console.error("Error getting profile", err);
                    });
                }
            }).catch(err => {
                console.error("Error initializing LIFF", err);
            });
            
            // ログインボタン
            document.getElementById('loginBtn').addEventListener('click', () => {
                liff.login();
            });
            
            // フォーム送信
            document.getElementById('surveyForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                // 送信中表示
                document.getElementById('surveyForm').style.display = 'none';
                document.getElementById('loading').style.display = 'block';
                
                // フォームデータ取得
                const formData = {
                    timestamp: new Date().toISOString(),
                    userId: userProfile.userId,
                    displayName: userProfile.displayName,
                    question1: document.getElementById('question1').value,
                    question2: document.querySelector('input[name="question2"]:checked').value,
                    question3: document.getElementById('question3').value,
                };
                
                // Google Apps ScriptにPOST
                try {
                    const response = await fetch(gasUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(formData)
                    });
                    
                    const result = await response.json();
                    document.getElementById('loading').style.display = 'none';
                    
                    if (result.success) {
                        document.getElementById('successMessage').style.display = 'block';
                    } else {
                        throw new Error(result.message || "Unknown error");
                    }
                } catch (error) {
                    console.error("Error submitting form:", error);
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('errorMessage').style.display = 'block';
                }
            });
            
            // 閉じるボタン
            document.getElementById('closeBtn').addEventListener('click', () => {
                liff.closeWindow();
            });
            
            // 再試行ボタン
            document.getElementById('retryBtn').addEventListener('click', () => {
                document.getElementById('errorMessage').style.display = 'none';
                document.getElementById('surveyForm').style.display = 'block';
            });
        });
    </script>
</body>
</html>
