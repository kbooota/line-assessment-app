/**
 * LINEアンケートアプリからのデータを受け取りスプレッドシートに保存するWebアプリ
 */

// スプレッドシートのIDを設定
const SPREADSHEET_ID = 'YOUR_SPREADSHEET_ID'; // スプレッドシートのIDを設定
const SHEET_NAME = 'アンケート回答'; // シート名

/**
 * HTTPリクエストを処理するdoPost関数
 * @param {Object} e - POSTリクエストのイベントオブジェクト
 * @return {TextOutput} JSONレスポンス
 */
function doPost(e) {
  try {
    // リクエストのログ
    console.log("doPost called with data: " + (e.postData ? e.postData.contents : "No data"));
    
    // リクエストからJSONデータを取得
    let jsonData;
    try {
      jsonData = JSON.parse(e.postData.contents);
      console.log("Parsed JSON data: " + JSON.stringify(jsonData));
    } catch (parseError) {
      console.error("Error parsing JSON: " + parseError);
      return createJsonResponse({
        success: false,
        message: 'Invalid JSON format: ' + parseError.message
      });
    }
    
    // データの検証
    if (!validateData(jsonData)) {
      return createJsonResponse({
        success: false,
        message: 'Invalid data format'
      });
    }
    
    // スプレッドシートへの書き込み
    const result = saveToSpreadsheet(jsonData);
    
    // 成功レスポンスを返す
    return createJsonResponse({
      success: true,
      message: 'Data saved successfully',
      recordId: result.recordId
    });
    
  } catch (error) {
    // エラーログ
    console.error('Error processing request:', error);
    
    // エラーレスポンスを返す
    return createJsonResponse({
      success: false,
      message: 'Error: ' + error.message
    });
  }
}

/**
 * テスト用のGET処理（デバッグ用）
 */
function doGet(e) {
  // パラメータ付きのテスト用
  if (e && e.parameter && e.parameter.test === "true") {
    return ContentService.createTextOutput(JSON.stringify({
      status: "success",
      message: "テストモードです。POSTリクエストを送信してください。"
    })).setMimeType(ContentService.MimeType.JSON);
  }
  
  // 通常のアクセス
  return HtmlService.createHtmlOutput(
    '<h1>LINE Survey API</h1><p>This is a web app for handling survey responses from LINE LIFF app.</p>'
  ).setTitle('LINE Survey API');
}

/**
 * データの検証
 * @param {Object} data - 検証するデータオブジェクト
 * @return {Boolean} 検証結果
 */
function validateData(data) {
  // 必須フィールドの存在確認
  const requiredFields = ['timestamp', 'userId', 'displayName', 'question1', 'question2'];
  
  for (const field of requiredFields) {
    if (!data[field]) {
      console.error(`Required field missing: ${field}`);
      return false;
    }
  }
  
  return true;
}

/**
 * スプレッドシートにデータを保存する
 * @param {Object} data - 保存するデータオブジェクト
 * @return {Object} 保存結果
 */
function saveToSpreadsheet(data) {
  try {
    // スプレッドシートを開く
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    let sheet = ss.getSheetByName(SHEET_NAME);
    
    // シートが存在しない場合は作成
    if (!sheet) {
      sheet = ss.insertSheet(SHEET_NAME);
      
      // ヘッダー行の設定
      const headers = [
        '送信日時', 'LINE User ID', '表示名', 
        'Q1: サービスを知ったきっかけ', 
        'Q2: 満足度', 
        'Q3: 改善点'
      ];
      sheet.getRange(1, 1, 1, headers.length).setValues([headers])
           .setFontWeight('bold')
           .setBackground('#f3f3f3');
      
      // 列の幅を自動調整
      sheet.autoResizeColumns(1, headers.length);
      
      // フィルター設定
      sheet.getRange(1, 1, 1, headers.length).createFilter();
    }
    
    // 追加する行データを作成
    const rowData = [
      data.timestamp,
      data.userId,
      data.displayName,
      data.question1,
      data.question2,
      data.question3 || ''
    ];
    
    // 最終行の次の行にデータを追加
    const lastRow = sheet.getLastRow();
    sheet.getRange(lastRow + 1, 1, 1, rowData.length).setValues([rowData]);
    
    // タイムスタンプ列をフォーマット
    sheet.getRange(lastRow + 1, 1).setNumberFormat('yyyy/MM/dd HH:mm:ss');
    
    return {
      recordId: lastRow,
      timestamp: new Date().toISOString()
    };
  } catch (error) {
    console.error('Error saving to spreadsheet:', error);
    throw error; // 上位の関数でキャッチできるようにスロー
  }
}

/**
 * JSONレスポンスを作成
 * @param {Object} data - レスポンスデータ
 * @return {TextOutput} JSONレスポンス
 */
function createJsonResponse(data) {
  return ContentService.createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON);
}

/**
 * CORS対応のためのOptions処理
 */
function doOptions(e) {
  console.log("doOptions called");
  const headers = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Methods': 'POST, GET, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type, Authorization',
    'Access-Control-Max-Age': '86400'
  };
  
  return ContentService.createTextOutput('')
    .setMimeType(ContentService.MimeType.TEXT)
    .setHeaders(headers);
}
